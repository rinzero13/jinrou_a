from aiwolf_nlp_common.packet import Role
from utils.agent_logger import AgentLogger

class LieStrategyModule:
    def __init__(self, logger: AgentLogger):
        self.logger = logger
        
    def get_strategy_decision_instructions(self, role: Role) -> str:
        """
        M2: M3の計画に基づき、嘘戦略の有無を決定し、リスク評価と目標の拡張をJSONで決定させるための指示を生成する。
        """
        
        instructions = (
            "【M2: 戦略的嘘の拡張決定】\n"
            "あなたは、M3モジュールで決定された**主張の核**（User Promptに記載）に基づき、その目標を達成するために「**戦略的な嘘（欺瞞、情報隠蔽、ブラフを含む）**」が必要か否かを評価・決定します。\n"
            "**【戦略的柔軟性の確保】**：\n"
            "人狼陣営（人狼・狂人）である場合、**パワープレイ（自身の役職のCOなど）**といった**高リスク戦略**も、**陣営の最終的な勝利に繋がる明確な論理的裏付け**がある場合に限り採用を検討できます。単なる短期的な混乱を目的とするのではなく、**多ターンにわたる戦略的利益**を評価してください。\n"
        )


        # 1. 嘘の分類表 
        instructions += (
            "\n### 嘘の分類（Mechanism of Deception）\n"
            "あなたの決定する嘘は、以下のいずれかの分類に該当します。この分類から**最も戦略的に有利**なものを選択し、`lie_type`として出力してください。\n"
            "| 分類タイプ | 目的（欺瞞メカニズム） | 採用リスク/リターン |\n"
            "| :--- | :--- | :--- |\n"
            "| **Mechanism: FactualDeception** | **事実の偽造・虚偽:** 役職、占い結果、襲撃ターゲットなど、ゲーム内の核となる事実について嘘をつく。 | **高**リスク・**高**リターン（真偽が明確になりやすいため） |\n"
            "| **Mechanism: ConsistencyBreak** | **一貫性の偽装:** 過去の行動や発言と矛盾しないように装う、または意図的に矛盾を突いて混乱を誘う。 | **中**リスク・**中**リターン（ログ検証に依存するため） |\n"
            "| **Mechanism: Omission/Distortion** | **情報隠蔽・歪曲:** 事実の一部を語らない、または意図的に解釈を誇張/矮小化して誘導する。 | **低**リスク・**低〜中**リターン（嘘がバレにくいが、効果も限定的） |\n"
            "| **Mechanism: DirectBluff** | **直接的なブラフ:** 証拠なしで、次の行動（投票/襲撃）について誤った宣言をする。 | **中**リスク・**中**リターン（即時的な行動誘導に強い） |\n"
        )
        
        # 2. 評価ロジックとリスク・リターン計算の具体化
        instructions += (
            "\n### 評価ロジックと目標の決定\n"
            "**【意思決定の原則】**：常に「**リターン (R) - コスト (C) - リスク (D) = 期待価値 (EV) > 0**」となる選択をしてください。\n"
            
            "**1. 戦略的リスク・リターン評価:** \n"
            "   - **リターン (R):** この戦略（嘘）が成功した場合、あなたの陣営の**勝利確率**はどれだけ向上するか？\n"
            "   - **コスト (C):** この嘘を実現するための発話の複雑性、他のエージェントを説得するための労力は？\n"
            "   - **リスク (D)（嘘がバレる確率）:** この嘘が露見した場合、あなたや勝利に必須の味方が吊られる確率は？（過去の自分の発言・行動との**論理的矛盾**も考慮）\n"
            
            "**2. 論理的自己検証:** 提案する嘘は、**論理的一貫性を保ち、他者から反証されない****完璧なブラフ**として構築できますか？\n"

            "\n**【嘘が不要なパターン (lie_used: false) の決定】**\n"
            "**以下のいずれかに該当する場合、`lie_used: false` を選択してください。**\n"
            "A. M3の主張の核（core_goal）が、**嘘を使わなくても十分な効果**を発揮し、EVが最大となる場合。\n"
            "B. 嘘を使うことのリスク (D) が**リターン (R) を上回る**場合。\n"
            "C. 提示できる有効な嘘戦略がなく、**真実を語るのが最も安全な防御**となる場合。\n"
        )
        
        # 3. JSON出力形式
        instructions += (
            "\n【出力形式】:\n"
            "思考プロセスは不要です。必ず以下の**JSON形式**で、**唯一のオブジェクト**を出力してください。\n"
            "**`lie_used: false` の場合、`extended_goal`はM3の主張の核と**同一の文字列**を記述してください。**\n"
            "```json\n"
            "{\n"
            "  \"lie_used\": true | false,\n"
            "  \"lie_type\": \"[上記分類表から選択したタイプを記述。lie_used: falseの場合は 'None']\",\n"
            "  \"risk_rating\": \"Low\" | \"Medium\" | \"High\" | \"None\",\n"
            "  \"extended_goal\": \"[嘘戦略を組み込んだ最終目標を記述。lie_used: falseの場合はM3の主張の核をそのまま記述]\"\n"
            "}\n"
            "```\n"
        )
        self.logger.logger.debug("M2 Lie strategy decision instructions generated with explicit 'false' pattern.")
        return instructions